## 文件上传漏洞的原理
用户能够控制自己上传文件，web应用没有经过过滤或者没有严格过滤，上传的恶意文件被保存到服务器当做脚本文件来执行。</br>
**漏洞成因：**
（1）未过滤或web前端被绕过；</br>
（2）文件检测被绕过</br>
（3）中间件解析</br>
（4）不完善的黑名单扩展名</br>
（5）文件路径截断</br>
（6）HTTP不安全方法（PUT协议）

## 文件上传漏洞的利用
### （1）无限制，可以直接上传
### （2）绕过前端或者过滤JS，进行上传文件
**方法一：**  修改JS代码，甚至删除表单事件，禁用JS</br>
**方法二：**  上传文件符合白名单策略，再burpsuite挂代理抓包修改文件后缀。
### （3）绕过mime-type值检验
**概念：** 在服务器端，如果上传文件的mime-type值与白名单一致，则允许上传。</br>
**绕过方法：** Burpsuite抓包修改</br>
         服务器检测Content-Type类型，去的变量来自用户，用户可以抓包修改字段使其合法，以此绕过</br>
         Content-Type:image/ipeg;image/png;image/gif</br>
### （4）文件头检验
**概念：** 每一个特定文件都有不一样的开头或者标志位，即文件幻数；文件头检测就是利用文件幻数对文件类型的验证机制。</br>
**利用方式：**</br>
（a）抓包修改：抓到的上传文件的包中，在代码前添加文件头，然后放行包。图片的文件头如下：</br>
                   jpeg/jpg/png：JPGGraphic File</br>
                   gif：GIF 89a</br>
                   zip：Zip Compressed</br>
（b）图片码，制作图片马绕过
### （5）黑名单绕过
当上传的文件后缀名是在黑名单中的没有后缀名，文件才能上传成功。
**绕过方式：**
（a）文件名大小写绕过，如 Asp，PHp；过滤严格会用strtolower()函数把后缀名全部变为小写，就不能绕过了。</br>
（b）特殊文件名绕过</br>
Windows系统下不符合文件命名规则的，会被系统自动去掉不符合规则符号后面的内容。常见的特殊文件名绕过有：test.asp.、test.asp（空格）、test.php:1.jpg、shell.php::$DATA</br>
Linux/Windows系统下可以尝试后缀名大小写。</br>
（c）00截断绕过</br>
条件：php版本小于5.3.4；php的magic_quotes_gpc为OFF状态</br>
方法：</br>
         知道上传路径，用burp抓包在上传路径后面加上1.php%00，然后将%00进行url编码</br>
         不知道上传路径，文件名改为1.php_jpg，这个+其实就是标识作用，burp抓包后，用hex打开将+的数值改为0</br>
### （6） 白名单绕过
当上传的文件后缀名是在白名单中有的后缀名，文件才能上传成功。</br>
白名单绕过：
![image](https://github.com/n4ttt/Sec-Note/assets/32692640/72069367-841e-4326-963e-f363ac091dfc)


## 文件上传漏洞的防御
**代码角度：**  </br>
（1）采用白名单策略，严格限制上传文件的后缀；</br>
（2）进行二次渲染，过滤掉图片马中的恶意代码；</br>
（3）上传文件重命名，尽量少的从客户端获取信息；</br>
（4）避免文件包含漏洞；</br>
（5）严格处理文件路径，防御00截断漏洞，避开空格、点、::DATA等的Windows特性；</br>
**服务器角度：**  </br>
（6）及时更新web容器，防止解析漏洞产生；</br>
（7）可写目录不给执行权限。
